---
title: Streaming SSR
description: Progressive HTML rendering with ReadableStream for improved TTFB
---

# Streaming SSR

Constela supports streaming server-side rendering using the Web Streams API. This enables progressive HTML delivery for improved Time to First Byte (TTFB) and better user experience.

## Basic Usage

```typescript
import { renderToStream, createHtmlTransformStream } from '@constela/server';

// Render program to stream
const contentStream = renderToStream(compiledProgram, {
  flushStrategy: 'batched',
});

// Wrap with HTML document structure
const htmlStream = contentStream.pipeThrough(
  createHtmlTransformStream({
    title: 'My Page',
    lang: 'en',
    stylesheets: ['/styles.css'],
    scripts: ['/client.js'],
  })
);

// Return as Response
return new Response(htmlStream, {
  headers: { 'Content-Type': 'text/html; charset=utf-8' },
});
```

## Flush Strategies

### `immediate`

Flush each chunk as soon as it's ready. Best for real-time streaming.

```typescript
renderToStream(program, { flushStrategy: 'immediate' });
```

### `batched` (Default)

Batch chunks until buffer exceeds 1KB threshold. Balances streaming with efficiency.

```typescript
renderToStream(program, { flushStrategy: 'batched' });
```

### `manual`

Only flush at the end. Use for small pages where streaming provides no benefit.

```typescript
renderToStream(program, { flushStrategy: 'manual' });
```

## Render Options

```typescript
interface StreamRenderOptions {
  route?: {
    params?: Record<string, string>;
    query?: Record<string, string>;
    path?: string;
  };
  imports?: Record<string, unknown>;
  styles?: Record<string, StylePreset>;
  stateOverrides?: Record<string, unknown>;
  cookies?: Record<string, string>;
  signal?: AbortSignal;
}
```

### Route Context

Pass route parameters for dynamic pages:

```typescript
const stream = renderToStream(program, { flushStrategy: 'batched' }, {
  route: {
    params: { id: '123' },
    query: { tab: 'overview' },
    path: '/users/123',
  },
});
```

### State Overrides

Override initial state values:

```typescript
const stream = renderToStream(program, { flushStrategy: 'batched' }, {
  stateOverrides: {
    user: { name: 'John', email: 'john@example.com' },
  },
});
```

### Cookie Support

Pass cookies for SSR-safe state initialization:

```typescript
const stream = renderToStream(program, { flushStrategy: 'batched' }, {
  cookies: {
    theme: 'dark',
    locale: 'ja-JP',
  },
});
```

## Abort Signal

Cancel streaming when the client disconnects:

```typescript
const controller = new AbortController();

const stream = renderToStream(program, { flushStrategy: 'batched' }, {
  signal: controller.signal,
});

// Cancel on client disconnect
request.signal.addEventListener('abort', () => {
  controller.abort();
});
```

## HTML Transform Stream

Wrap content with HTML document structure:

```typescript
const htmlStream = contentStream.pipeThrough(
  createHtmlTransformStream({
    title: 'My Page',
    lang: 'en',
    meta: {
      description: 'Page description',
      'og:title': 'My Page',
    },
    stylesheets: ['/styles.css', '/theme.css'],
    scripts: ['/client.js'],
  })
);
```

### Options

| Option | Type | Description |
|--------|------|-------------|
| `title` | `string` | Page title (required) |
| `lang` | `string` | HTML lang attribute (default: "en") |
| `meta` | `Record<string, string>` | Meta tags |
| `stylesheets` | `string[]` | CSS file paths |
| `scripts` | `string[]` | Script file paths |

## Suspense Boundaries

Use suspense for async content:

```json
{
  "kind": "suspense",
  "id": "user-data",
  "fallback": {
    "kind": "element",
    "tag": "div",
    "props": { "className": { "expr": "lit", "value": "skeleton" } }
  },
  "content": {
    "kind": "component",
    "name": "UserProfile"
  }
}
```

Server renders with markers:

```html
<div data-suspense-id="user-data">
  <div class="skeleton"></div>
</div>
```

## Edge Runtime Integration

### Cloudflare Workers

```typescript
import { renderToStream, createHtmlTransformStream } from '@constela/server';

export default {
  async fetch(request: Request) {
    const stream = renderToStream(program, { flushStrategy: 'batched' })
      .pipeThrough(createHtmlTransformStream({ title: 'My App' }));

    return new Response(stream, {
      headers: { 'Content-Type': 'text/html; charset=utf-8' },
    });
  },
};
```

### Vercel Edge

```typescript
import { renderToStream, createHtmlTransformStream } from '@constela/server';

export const config = { runtime: 'edge' };

export default async function handler(request: Request) {
  const stream = renderToStream(program, { flushStrategy: 'batched' })
    .pipeThrough(createHtmlTransformStream({ title: 'My App' }));

  return new Response(stream, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' },
  });
}
```

### Deno Deploy

```typescript
import { renderToStream, createHtmlTransformStream } from '@constela/server';

Deno.serve(async (request) => {
  const stream = renderToStream(program, { flushStrategy: 'batched' })
    .pipeThrough(createHtmlTransformStream({ title: 'My App' }));

  return new Response(stream, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' },
  });
});
```

## Configuration

Enable streaming in `constela.config.json`:

```json
{
  "streaming": {
    "enabled": true,
    "flushStrategy": "batched"
  }
}
```

## Performance Tips

1. **Use `batched` by default** - Balances streaming with network efficiency
2. **Use `immediate` for long pages** - Users see content faster
3. **Use `manual` for small pages** - Reduces overhead
4. **Add suspense boundaries** - Shows loading states for async content
5. **Enable gzip/brotli** - Compress streamed chunks
